/**
 * Фильтр "что считать специализацией ветклиники".
 * Наша цель: убрать из списков и отчётов служебные/финансовые/админские категории
 * (например: "Уборщица", "Инженер", "Генеральный директор", "Оплата стационара" и т.д.)
 *
 * Диагностику (МРТ/КТ/УЗИ) оставляем.
 */

// Нормализация так, чтобы корректно работало для кириллицы:
// - ё → е
// - всё, что не буква/цифра → пробел
// - пробелы схлопываем
function norm(s: string) {
  return (s ?? "")
    .toString()
    .normalize("NFKC")
    .toLowerCase()
    .replace(/ё/g, "е")
    .replace(/[^\p{L}\p{N}]+/gu, " ")
    .trim()
    .replace(/\s+/g, " ");
}

// Важно: НЕ используем \b для кириллицы (в JS оно опирается на ASCII \w),
// поэтому фильтруем по токенам/префиксам.
const NOISE_TOKEN_PREFIXES: string[] = [
  // финансы/оплаты
  "оплат",
  "платеж", // платёж → платеж (после ё→е)
  "счет", // счёт → счет
  "касс",
  "возврат",
  "скидк",
  "депозит",
  "аванс",
  "начисл",
  "штраф",
  "пеня",
  "пени",

  // админка/персонал
  "уборщ",
  "инженер",
  "директор",
  "генеральн",
  "бухгалтер",
  "кассир",
  "администратор",
  "администр",
  "менеджер",
  "менедж",
  "маркет",
  "курьер",
  "водител",
  "охран",
  "секретар",
  "юрист",

  // внутренние расходы
  "зарплат",
  "оклад",
  "преми",
  "налог",
  "аренд",
  "коммун",
  "канцел",
  "хоз",
  "интернет",
  "хостинг",

  // тестовые/служебные
  "тест",
  "демо",
  "demo",
];

const NOISE_TOKEN_EXACT = new Set<string>([
  "smm",
  "hr",
  // англ. должности/служебка (на всякий)
  "ceo",
  "cfo",
  "cto",
  "admin",
  "manager",
  "marketing",
  "salary",
  "rent",
  "cleaner",
  "engineer",
]);

export function isVetSpecialization(name: string | null | undefined): boolean {
  const n = norm(name ?? "");
  if (!n) return false;
  // совсем короткие мусорные значения
  if (n.length <= 1) return false;

  const tokens = n.split(" ").filter(Boolean);
  for (const t of tokens) {
    if (NOISE_TOKEN_EXACT.has(t)) return false;
    for (const p of NOISE_TOKEN_PREFIXES) {
      if (t.startsWith(p)) return false;
    }
  }

  return true;
}
